<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Billing Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #fff;
            --primary-blue: #2563eb;
            --emerald: #10b981;
            --orange: #f59e42;
            --table-header: #f2f5fa;
            --gray-bg: #f7fafd;
            --medium-gray: #5d6470;
            --light-gray: #eef2f7;
            --card: #f7fafd;
            --border: #eceef2;
            --radius: 16px;
            --header: #23272f;
        }

        body {
            background: var(--white);
            font-family: 'Inter', Arial, sans-serif;
            color: var(--header);
            margin: 0;
        }

        .dashboard-container {
            padding: 1.1rem 3vw 1.4rem 3vw;
            max-width: 1320px;
            margin: auto;
            box-sizing: border-box;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.8rem;
        }
        .header-title {
            font-size: 2.05rem;
            font-weight: 800;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
        }
        .header-title i {margin-right: 12px; font-size: 1.3em;}
        .form-select-futuristic {
            background: var(--gray-bg);
            border: 1.2px solid var(--border);
            border-radius: 13px;
            color: var(--header);
            padding: 0.63rem 1rem;
            font-size: 1rem;
            font-weight: 500;
        }

        .glass-card {
            background: var(--card);
            border: 1.2px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 8px 16px rgba(220,228,245,0.13);
            transition: box-shadow .18s, transform .13s;
            margin-bottom: 1.05rem;
            padding: 1.08rem 1rem 0.75rem 1rem;
            min-width: 0;
        }
        .glass-card:hover {
            box-shadow: 0 16px 62px 0 rgba(140,180,235,0.10);
            transform: translateY(-2px) scale(1.009);
        }

        .kpi-cards {
            gap: 1.08rem;
            margin-bottom: 1.1rem;
            display: flex; flex-wrap: wrap;
        }
        .kpi-card {
            display: flex; flex-direction: column; align-items: flex-start;
            padding: 1.12rem 1.08rem 1.08rem 1.05rem;
            min-width: 210px;
            min-height: 99px;
            background: var(--gray-bg);
            border-radius: var(--radius);
            box-shadow: 0 1px 4px rgba(180,190,220,0.08);
        }
        .kpi-label {
            font-size: 0.96rem;
            font-weight: 600;
            color: var(--medium-gray);
            margin-bottom: 0.22rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .kpi-value {
            font-size: 1.85rem;
            font-weight: 800;
            color: var(--primary-blue);
            margin-top: 0.24rem;
        }
        .kpi-value[data-green="true"] { color: var(--emerald);}
        .kpi-value[data-orange="true"] { color: var(--orange);}
        
        .alert {
            background: #fff7e6;
            color: #bb6900;
            font-weight: 700;
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            margin: 1.25rem 0 2.1rem 0;
            font-size: 1.08rem;
        }
        .alert a {
            color: var(--primary-blue);
            text-decoration: underline;
            font-weight: 700;
        }
        #loadingIndicator {
            color: var(--primary-blue);
            text-align: center;
            padding: 3.5rem 0 1.7rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .dashboard-charts {
            display: flex;
            gap: 1.3rem;
            flex-wrap: wrap;
            margin-bottom: 1.18rem;
        }
        .chart-col {
            flex: 1 1 320px;
            min-width: 290px;
            margin-bottom: 0;
            display: flex; flex-direction: column;
        }
        .chart-title {
            color: var(--primary-blue);
            font-weight: 700;
            font-size: 1.06rem;
            margin-bottom: .7rem;
        }
        .chart-container {
            position: relative;
            height: 305px;
            min-width: 0;
        }
        .table-section {
            margin-bottom: .38rem;
            background: var(--gray-bg);
        }
        .table-container {
            max-height: 450px;
            overflow-y: auto;
            border-radius: var(--radius);
            background: var(--white);
            margin-bottom: 0;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }
        th, td {
            padding: 0.7rem 1.08rem;
            text-align: left;
        }
        th {
            color: var(--primary-blue);
            background: var(--table-header);
            border-bottom: 2px solid var(--border);
            font-size: 1rem;
        }
        td {
            color: var(--header);
            background: var(--white);
            border-bottom: 1px solid var(--border);
            font-size: 1rem;
        }
        tr:hover td { background: var(--light-gray);}

        /* --- UPDATED Drill-down styles --- */
        .service-row, .region-row { cursor: pointer; }
        .region-row td { padding-left: 2.5rem !important; background-color: #f8f9fa; }
        .instance-row td { padding-left: 4rem !important; background-color: #ffffff; }
        .region-row:hover td { background-color: #e9ecef !important; }
        .instance-row:hover td { background-color: #f1f3f5 !important; }


        @media (max-width: 1150px) {
            .dashboard-container {padding: 0.7rem 1vw;}
            .dashboard-charts, .kpi-cards { flex-direction: column;}
            .chart-col {min-width: 0;}
        }
        @media (max-width:670px){
            .dashboard-container {padding: 0.5rem 0;}
            .header-title {font-size:1.18rem;}
            .glass-card { padding: 1rem .6rem;}
            .kpi-card {padding: .95rem .7rem;}
            .chart-container {height: 160px;}
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="dashboard-container">
        <div class="header-bar">
            <div class="header-title">
                <i class="fas fa-chart-line"></i> Billing Overview
            </div>
            <div th:if="${accounts}">
                <select id="accountSelector" class="form-select form-select-futuristic" style="min-width:180px;">
                    <option th:each="account : ${accounts}" th:value="${account.id}" th:text="${account.accountName}"></option>
                </select>
            </div>
        </div>
        <div th:if="${accounts == null or accounts.isEmpty()}" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> No connected accounts found.
            Please <a th:href="@{/account/add}" class="alert-link">add an account</a> to view billing data.
        </div>
        <div id="loadingIndicator" style="display: none;">
            <p><i class="fas fa-spinner fa-spin"></i> Loading billing data...</p>
        </div>
        <div id="billingContent" style="display: none;">
            <div class="kpi-cards">
                <div class="glass-card kpi-card">
                    <div class="kpi-label">Month-to-Date Spend</div>
                    <div class="kpi-value" id="mtdSpend">$0.00</div>
                </div>
                <div class="glass-card kpi-card">
                    <div class="kpi-label">Forecasted Spend</div>
                    <div class="kpi-value" id="forecastedSpend" data-green="true">$0.00</div>
                </div>
                <div class="glass-card kpi-card">
                    <div class="kpi-label">Last Month Spend</div>
                    <div class="kpi-value" id="lastMonthSpend">$0.00</div>
                </div>
            </div>
            <div class="dashboard-charts">
                <div class="glass-card chart-col">
                    <div class="chart-title">Last 6 Months Cost History</div>
                    <div class="chart-container">
                        <canvas id="costHistoryChart"></canvas>
                    </div>
                </div>
                <div class="glass-card chart-col">
                    <div class="chart-title">Cost By Service</div>
                    <div class="chart-container">
                        <canvas id="costByServiceChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="table-section glass-card">
                <div class="d-flex justify-content-between align-items-center mb-3 p-3">
                    <div class="chart-title">Cost Breakdown</div>
                    <div>
                        <select id="monthFilter" class="form-select form-select-futuristic d-inline-block w-auto me-2"></select>
                        <button id="downloadCsvBtn" class="btn btn-primary btn-sm">Download CSV</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Service/Region/Instance</th>
                            <th>Cost</th>
                        </tr>
                        </thead>
                        <tbody id="costBreakdownTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const accountSelector = document.getElementById('accountSelector');
            const monthFilter = document.getElementById('monthFilter');
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');
            
            populateMonthFilter();

            if (accountSelector && accountSelector.value) {
                loadBillingData(accountSelector.value);
                accountSelector.addEventListener('change', (event) => {
                    if (event.target.value) loadBillingData(event.target.value);
                });
                monthFilter.addEventListener('change', () => {
                    if(accountSelector.value) loadBillingData(accountSelector.value);
                });
                downloadCsvBtn.addEventListener('click', downloadCSV);
            } else {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('billingContent').style.display = 'none';
            }
        });

        let costHistoryChart, costByServiceChart;
        let currentCostBreakdown = [];

        function populateMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            const now = new Date();
            for (let i = 0; i < 6; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const option = document.createElement('option');
                option.value = `${date.getFullYear()}-${date.getMonth() + 1}`;
                option.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                monthFilter.appendChild(option);
            }
        }

        async function loadBillingData(accountId) {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('billingContent').style.display = 'none';

            const [year, month] = document.getElementById('monthFilter').value.split('-');
            const url = `/api/billing/data/${accountId}?year=${year}&month=${month}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to fetch data: ${response.statusText}`);
                const data = await response.json();

                currentCostBreakdown = data.costBreakdown;

                updateKPIs(data);
                renderCostHistoryChart(data.costHistory);
                renderCostByServiceChart(data.costByService);
                updateCostBreakdownTable(data.costBreakdown);

            } catch (error) {
                console.error('Error loading billing data:', error);
                alert('Failed to load billing data. Please check the console for details.');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('billingContent').style.display = 'block';
            }
        }

        function downloadCSV() {
            const headers = "Service,Cost\n";
            const rows = currentCostBreakdown.map(item => `"${item.name}",${item.cost.toFixed(2)}`).join('\n');
            const csvContent = headers + rows;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "cost_breakdown.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateKPIs(data) {
            const formatCurrency = (value) => `$${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('mtdSpend').textContent = formatCurrency(data.monthToDateSpend);
            document.getElementById('forecastedSpend').textContent = formatCurrency(data.forecastedSpend);
            document.getElementById('lastMonthSpend').textContent = formatCurrency(data.lastMonthSpend);
        }
        
        Chart.defaults.color = "#23272f";
        Chart.defaults.borderColor = "#eceef2";
        Chart.defaults.font.family = "Inter, Arial, sans-serif";

        function renderCostHistoryChart(costHistory) {
            const ctx = document.getElementById('costHistoryChart').getContext('2d');
            const labels = costHistory.map(item => new Date(item.date).toLocaleString('default', { month: 'short', year: '2-digit' }));
            const data = costHistory.map(item => item.cost || 0);
            const backgroundColors = costHistory.map(item => item.isAnomaly ? 'rgba(239, 68, 68, 0.7)' : 'rgba(37, 99, 235, 0.7)');
            
            if (costHistoryChart) costHistoryChart.destroy();
            costHistoryChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Monthly Cost', data, backgroundColor: backgroundColors, borderRadius: 8 }] },
                options: { animation: { duration: 1000 }, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderCostByServiceChart(costByService) {
            const ctx = document.getElementById('costByServiceChart').getContext('2d');
            const topServices = costByService.sort((a, b) => b.cost - a.cost).slice(0, 7);
            const labels = topServices.map(item => item.name);
            const data = topServices.map(item => item.cost);
            const totalCost = data.reduce((a, b) => a + b, 0);

            if (costByServiceChart) costByServiceChart.destroy();
            costByServiceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data, backgroundColor: ["#2563eb", "#10b981", "#f59e42", "#5d6470", "#a1b5d8", "#e5e7eb", "#ede9fe"], borderWidth: 1.3, borderColor: "#f7fafd" }]
                },
                options: {
                    animation: { duration: 1250 },
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 16, font: { weight: 'bold' } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = totalCost > 0 ? ((value / totalCost) * 100).toFixed(1) : 0;
                                    return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCostBreakdownTable(costBreakdown) {
            const tableBody = document.getElementById('costBreakdownTableBody');
            tableBody.innerHTML = '';
            costBreakdown.sort((a, b) => b.cost - a.cost).forEach(item => {
                const row = document.createElement('tr');
                row.className = 'service-row';
                row.dataset.serviceName = item.name;
                row.innerHTML = `<td><i class="fas fa-caret-right fa-fw"></i> ${item.name}</td><td>$${item.cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
                row.addEventListener('click', () => toggleRegionBreakdown(row, item.name));
                tableBody.appendChild(row);
            });
        }

        async function toggleRegionBreakdown(serviceRow, serviceName) {
            const isAlreadyOpen = serviceRow.classList.contains('expanded');

            if (isAlreadyOpen) {
                serviceRow.classList.remove('expanded');
                let nextSibling = serviceRow.nextElementSibling;
                while (nextSibling && (nextSibling.classList.contains('region-row') || nextSibling.classList.contains('instance-row'))) {
                    let toRemove = nextSibling;
                    nextSibling = nextSibling.nextElementSibling;
                    toRemove.remove();
                }
                return;
            }

            serviceRow.classList.add('expanded');
            const accountId = document.getElementById('accountSelector').value;
            const [year, month] = document.getElementById('monthFilter').value.split('-');
            
            const response = await fetch(`/api/billing/breakdown/regions?accountId=${accountId}&serviceName=${encodeURIComponent(serviceName)}&year=${year}&month=${month}`);
            const regionData = await response.json();

            if (regionData.length > 0) {
                let lastElement = serviceRow;
                regionData.sort((a, b) => b.cost - a.cost).forEach(region => {
                    const regionRow = document.createElement('tr');
                    regionRow.className = 'region-row';
                    regionRow.dataset.regionName = region.name;
                    regionRow.innerHTML = `<td><i class="fas fa-caret-right fa-fw"></i> ${region.name}</td><td>$${region.cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
                    
                    regionRow.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        toggleInstanceBreakdown(regionRow, serviceName, region.name);
                    });
                    lastElement.after(regionRow);
                    lastElement = regionRow;
                });
            }
        }
        
        async function toggleInstanceBreakdown(regionRow, serviceName, regionName) {
            const isAlreadyOpen = regionRow.classList.contains('expanded');

            if (isAlreadyOpen) {
                regionRow.classList.remove('expanded');
                let nextSibling = regionRow.nextElementSibling;
                while (nextSibling && nextSibling.classList.contains('instance-row')) {
                    let toRemove = nextSibling;
                    nextSibling = nextSibling.nextElementSibling;
                    toRemove.remove();
                }
                return;
            }

            regionRow.classList.add('expanded');
            const accountId = document.getElementById('accountSelector').value;
            
            const response = await fetch(`/api/billing/breakdown/instances?accountId=${accountId}&region=${regionName}&serviceName=${encodeURIComponent(serviceName)}`);
            const instanceData = await response.json();
            
            if (instanceData.length > 0) {
                let lastElement = regionRow;
                 instanceData.sort((a,b) => b.cost - a.cost).forEach(instance => {
                    const instanceRow = document.createElement('tr');
                    instanceRow.className = 'instance-row';
                    instanceRow.innerHTML = `<td>${instance.name} (${instance.id})</td><td>$${instance.cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
                    lastElement.after(instanceRow);
                    lastElement = instanceRow;
                });
            }
        }

    </script>
</div>
</body>
</html>